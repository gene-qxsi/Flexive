<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .header {
      display: flex;
      justify-content: flex-end;
      padding: 10px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
      position: relative;
    }
    .profile-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .profile-menu {
      display: none;
      position: absolute;
      top: 60px;
      right: 10px;
      background: white;
      border: 1px solid #ddd;
      padding: 10px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }
    .auth-links {
      margin-top: 10px;
    }
    .auth-links a {
      display: block;
      text-decoration: none;
      color: #007bff;
      margin-bottom: 5px;
    }
    .chat-list {
      margin: 20px;
      padding: 0;
      list-style-type: none;
    }
    .chat-item {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      padding: 10px;
      cursor: pointer;
    }
    /* –°—Ç–∏–ª—å –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ */
    .chat-form {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      width: 300px;
      border: 1px solid #ddd;
    }
    .chat-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .chat-form button {
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .chat-form button:hover {
      background-color: #0056b3;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://img.megastroycdn.ru/llMNn8MH31c/products/06d0d4be36d15f8565d55364b562d6b953f6334f957f2f47bfbc0885a15d2f4f/13364_2_436451adad03f58b4ee7248fa3217563.jpg"
         alt="User" class="profile-icon" id="profileIcon">
    <div class="profile-menu" id="profileMenu"></div>
  </div>

  <div>
    <h2>–í—Å–µ —á–∞—Ç—ã</h2>
    <ul id="chatList" class="chat-list">
      <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
    </ul>
    <button id="createChatBtn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button> <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ -->
  </div>

  <!-- –û–∫–Ω–æ —Å —Ñ–æ—Ä–º–æ–π —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ -->
  <div class="overlay" id="overlay"></div>
  <div class="chat-form" id="chatForm">
    <h3>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h3>
    <input type="text" id="chatTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞" required>
    <button id="submitChatBtn">–°–æ–∑–¥–∞—Ç—å</button>
  </div>

  <script>
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("load", () => {
      const wsUrl = "ws://localhost/websockets/"; // URL –¥–ª—è WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log("WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
      };

      ws.onmessage = (event) => {
        console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket:", event.data);
      };

      ws.onerror = (error) => {
        console.error("–û—à–∏–±–∫–∞ WebSocket:", error);
      };

      ws.onclose = () => {
        console.log("WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
      };

      window.ws = ws;
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    async function authFetch(url, options = {}) {
      const accessToken = localStorage.getItem("accessToken");
      const headers = {
        "Content-Type": "application/json",
        ...options.headers,
        "Authorization": `Bearer ${accessToken}`
      };
      return fetch(url, { ...options, headers });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —á–∞—Ç–æ–≤
    async function loadChats() {
    try {
        const response = await authFetch("http://localhost/chats"); // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —á–∞—Ç–∞—Ö
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        }
        const chats = await response.json(); // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –≤ JSON
        const chatList = document.getElementById("chatList");
        chatList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤

        chats.forEach((chat) => {
            const li = document.createElement("li");
            li.classList.add("chat-item");
            li.textContent = chat.title; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —á–∞—Ç—ã –∏–º–µ—é—Ç –ø–æ–ª–µ "title"

            // üü¢ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            li.addEventListener("click", () => {
                window.location.href = `chat.html?id=${chat.id}`; // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–∞—Ç–∞ —Å ID
            });

            chatList.appendChild(li);
        });
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:", error);
    }
}

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadChats();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∏–∫–æ–Ω–∫–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById("profileIcon").addEventListener("click", async function() {
      const menu = document.getElementById("profileMenu");

      if (menu.style.display === "block") {
        menu.style.display = "none";
        return;
      }

      try {
        const response = await authFetch("http://localhost/profiles/me");
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        }
        const data = await response.json();

        menu.innerHTML = ` 
          <p>–ò–º—è: ${data.name || data.username || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</p>
          <p>Email: ${data.email || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
        `;
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
        menu.innerHTML = ` 
          <p>–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</p>
          <div class="auth-links">
            <a href="/signup.html">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            <a href="/signin.html">–í—Ö–æ–¥</a>
          </div>
        `;
      }

      menu.style.display = "block";
    });

  </script>
</body>
</html>